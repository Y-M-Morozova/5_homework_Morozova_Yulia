**<div align="center"><h2>Морозова Юлия, OTUS, группа Postgre-DBA-2023-11</h2></div>**

**<div align=center><h3>Домашнее задание №5 по теме:</h3></div>**
**<div align=center><h3>«MVCC, vacuum и autovacuum.»</h3></div>**

***
**<h3>Домашнее задание:
<br>Настройка autovacuum с учетом особеностей производительности**

**<h3>Цель:
<br>запустить нагрузочный тест pgbench
<br>настроить параметры autovacuum
<br>проверить работу autovacuum.</h3>**

***
**Выполнение:**

>**1. Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB**


<br/>

>**2. Установить на него PostgreSQL 15 с дефолтными настройками**

<br/>

>**3. Создать БД для тестов: выполнить pgbench -i postgres**


  <br/>

>**4. Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres**



  <br/>

>**5. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла**




<br/>
  
>**6. Протестировать заново**


 <br/> 

>**7. Что изменилось и почему?**


<br/> 

>**8. Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк**


<br/>

>**9. Посмотреть размер файла с таблицей**


<br/>

>**10. 5 раз обновить все строчки и добавить к каждой строчке любой символ**



<br/>

>**11. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум**


<br/>

>**12. Подождать некоторое время, проверяя, пришел ли автовакуум**


<br/>

>**13. 5 раз обновить все строчки и добавить к каждой строчке любой символ**


<br/>

>**14. Посмотреть размер файла с таблицей**


<br/>

>**15. Отключить Автовакуум на конкретной таблице**


<br/>


>**16. 10 раз обновить все строчки и добавить к каждой строчке любой символ**



<br/>

>**17. Посмотреть размер файла с таблицей**



<br/>

>**18. Объясните полученный результат**



<br/>

>**19. Не забудьте включить автовакуум)**



<br/>  


***
**<h3> Задание со * :
<br>Написать анонимную процедуру, в которой в цикле 10 раз обновятся все строчки в искомой таблице.
<br>Не забыть вывести номер шага цикла**

***






>**20. подсказка в шпаргалке под пунктом 20**

О, да! Кратко и понятно - посмотрела в шпаргалке, да: 

***таблица создана в схеме public а не testnm и прав на public для роли readonly не давали***

<br/> 

>**21. а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)**

 Потому,  что я осознанно сделала выбор - создавать таблицу в схеме по умолчанию, а это ``public``, не указывала схему  при создании таблицы как ``testnm``

<br/>

>**22. вернитесь в базу данных testdb под пользователем postgres**

  ![22_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/eb9c029e-75b2-4ccb-b941-eba30ecab63e)

<br/>

>**23. удалите таблицу t1**

выполняю командой и потом проверяю:

```sql
  drop table t1;
```

  ![23_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/e671cb69-10ae-4acd-b389-aad34e8053d6)

<br/>

>**24. создайте ее заново но уже с явным указанием имени схемы testnm**

выполняю командой и потом проверяю:

```sql
  create table testnm.t1 (c1 integer);
```

  ![24_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/d72c0d57-fc0a-4baa-a97b-0e2d0d421b1d)

<br/>

>**25. вставьте строку со значением c1=1**

выполняю командой и потом проверяю:

```sql
  insert into testnm.t1 (c1) values (1);
```

  ![25_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/ee2d0852-428e-45f7-ad92-387eaeb2be2f)

<br/>

>**26. зайдите под пользователем testread в базу данных testdb**

перехожу во второй терминал(мне так нагляднее) и там выполняю команду: ``psql -h 127.0.0.1 -p 5433 -U testread -d testdb``

  ![26_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/d4ab8e64-4e96-4637-a157-270479f04b1c)

<br/>

>**27. сделайте select * from testnm.t1;**

выполняю:

  ![27_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/86587024-cd3a-4666-a1b7-e31f22ab2425)

<br/>

>**28. получилось?**

Нет, не получилось! Снова получаю ошибку об отсутствии прав на эту таблицу у этого пользователя! 

<br/>

>**29. есть идеи почему? если нет - смотрите шпаргалку**

Я права давала ранее, для таблиц которые существовали на тот момент, а таблицу ``t1`` я создала позднее и права на неё не распространились.

<br/>

>**30. как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку**

Чтобы такое не повторялось определю привилегии доступа по умолчанию(для этого есть команда ``alter default privileges``). 
<br>В моем случае в схеме ``testnm`` для селекта для роли ``readonly`` выполню от пользователя ``postgres`` команду:

```sql
  ALTER default privileges in SCHEMA testnm grant SELECT on TABLES to readonly; 
```

  ![30_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/3f44287f-6458-4ff6-aa2a-271477cb5525)

<br/>

>**31. сделайте select * from testnm.t1;**

  ![31_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/963b592b-2ad6-4ef9-a0cc-e524d4f162f9)

<br/>

>**32. получилось?**

Нет!!!! Все та же ошибка - нет прав на эту таблицу!

<br/>

>**33. есть идеи почему? если нет - смотрите шпаргалку**

Я определила привилегии доступа по умолчанию(``alter default privileges``) для таблиц, создаваемых в будущем. А текущие права не меняла. Мне необходимо снова выполнить команду ``grant select`` или пересоздать таблицу ``t1``. Выполняю снова команду от пользователя ``postgres``: 

```sql
  grant select on all tables in schema testnm to readonly;
```

  ![33_2](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/0279381a-0c1a-4a9c-bcbe-80b4201758b1)

<br/>

>**34. сделайте select * from testnm.t1;**
 
Выполняю от пользователя ``testread``:

![34_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/f90e9c28-ea78-4ad3-b5ef-ffec34defb9f)

<br/>

>**35. получилось?**

ДА! Теперь все ок!

<br/>

>**36. ура!**

ДА !!!   :+1:

<br/>

>**37. теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);**

Выполняю от пользователя ``testread`` и все ок: таблица создалась, строка вставилась:  
  
  ![37_3](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/29263526-f925-47e8-8302-4456b7896517)

<br/>

>**38. а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?**

Так как схемы ``$USER`` нет, то таблица по умолчанию создалась в схеме ``public``. А когда я создавала нового пользователя , то ему по умолчанию была присвоена роль ``public``, которая позволяет выполнять все действия в схеме ``public`` в тех базах данных, к которым у пользователя есть доступ. 

<br/>

>**39. есть идеи как убрать эти права? если нет - смотрите шпаргалку**

Чтобы избежать такого поведения необходимо запретить создание объектов в схеме ``public`` и отозвать действующие права в схеме ``public``.
<br>Поэтому выполняю команды (под пользователем ``postgres``):

```sql
  REVOKE CREATE on SCHEMA public FROM public; 
  REVOKE ALL on DATABASE testdb FROM public;
```

  ![39_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/449aa11d-b777-41e6-93a9-be0e4d647ae3)

<br/>

>**40. если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды**

Вот в этом пункте , после долгих размышлений и смущений - честно сознаюсь - пошла смотреть шпаргалку! Спасибо, это было интересно ... и поучительно! Теперь разобралась - пунктом выше написала - в чем тут суть...

<br/>

>**41. теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);**

Выполняю от пользователя ``testread``:

  ![40_1](https://github.com/Y-M-Morozova/4_homework_Morozova_Yulia/assets/153178571/22441e2a-5672-478b-b059-1683d5c5317a)

<br/>

>**42. расскажите что получилось и почему**

А вот тут ожидаемо - создать таблицу не получилось(права на создание новых объектов в схеме ``public`` уже отозваны.)
<br>А вот вставить строку - получилось! И это тоже ожидаемо - я смотрела выше свойства таблицы - пользователь ``testread`` является собственником (``owner``) таблицы ``t2`` - он стал им , когда создавал её, поэтому он имеет права на эту таблицу, строку вставить смог!
<br/>

***
